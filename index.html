<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Writing Adapters for DataMapper</title>
   <meta name="author" content="Paul Sadauskas" />
   <meta name="company" content="Absolute Performance, Inc" />

   <!-- configuration parameters -->
   <meta name="defaultView" content="slideshow" />
   <meta name="controlVis" content="hidden" />

   <link rel="stylesheet" href="stylesheets/slides.css" type="text/css" media="projection" id="slideProj" />
   <link rel="stylesheet" href="stylesheets/outline.css" type="text/css" media="screen" id="outlineStyle" />

   <link rel="stylesheet" href="stylesheets/highlight.css" type="text/css" media="screen" />
   <!-- S5 JS -->
   <script src="javascripts/slides.js" type="text/javascript"></script>

   <script src="javascripts/highlight.pack.js" type="text/javascript"></script>
   <script type="text/javascript">
     hljs.initHighlightingOnLoad('ruby');
   </script>
</head>
<body>

<div class="layout">
  <div id="controls"><!-- DO NOT EDIT --></div>
  <div id="currentSlide"><!-- DO NOT EDIT --></div>
  <div id="header">MountainWest2009</div>
  <div id="footer">
    <h2>Copyright &copy; Paul Sadauskas - Creative Commons</h2>
  </div>
</div>

<div class="presentation">
  <div class="slide">
<h1 id='writing_datamapper_adapters'>Writing DataMapper Adapters</h1>

<p><a href='psadauskas@gmail.com'>Paul Sadauskas</a> a.k.a <a href='http://twitter.com/TheAmazingRando'>Rando</a></p>

<p><a href='http://absolute-performance.com'>Absolute Performance, Inc</a></p>

</div>

<div class="slide">
<h1 id='who_the_hell_are_you'>Who the Hell are You?</h1>

<p>I&#8217;m Paul Sadauskas. Find me on the intarwebs:</p>

<ul>
<li>irc: Rando@irc.freenode.net</li>

<li>xmpp: <a href='psadauskas@gmail.com'>psadauskas@gmail.com</a></li>

<li>www: <a href='http://theamazingrando.com/blog'>TheAmazingRando.com/blog</a></li>
</ul>

<p>DataMapper Hacker:</p>

<ul>
<li>Designed <code>AbstractAdapter</code> API</li>

<li>Wrote initial implementation of the reference adapter, <code>InMemoryAdapter</code></li>
</ul>

</div>

<div class="slide">
<h1 id='wtf_is_datamapper'>WTF is DataMapper?</h1>

<p>A lightweight, modular Ruby ORM.</p>

<ul>
<li>Lazy Loading</li>

<li>(Strategic) Eager Loading</li>

<li>Plugin Architecture</li>

<li>Non-Relational Database Adapters</li>
</ul>

</div>

<div class="slide">
<h1 id='lazyloading'>Lazy-Loading</h1>

<p>The query doesn&#8217;t hit the adapter until it has to.</p>

<pre><code>r = Article.all
r = r.all(:author =&gt; &quot;Paul&quot;)
r = r.all(:published_at.gt =&gt; 2.weeks.ago)
r.map { |a| a.title }
# results in this query:
# Article.all( :author =&gt; &quot;Paul&quot;,
#              :published_at.gt =&gt; 2.weeks.ago )</code></pre>

</div>

<div class="slide">
<h1 id='strategiceager_loading'>Strategic-Eager Loading</h1>

<p>When getting associated models from an object in a collection, get the associated models for all objects in that collection.</p>

<pre><code>articles.each { |a| a.comments }`
# =&gt; results in this query:
# Comment.all( :article =&gt; articles )</code></pre>

</div>

<div class="slide">
<h1 id='plugins'>Plugins</h1>

<ul>
<li>types - yaml, json, xml, regexp, uuid, csv, ip_address, uri</li>

<li>migrations</li>

<li>validations - flexible, extensible</li>

<li>timestamps - created_at, etc</li>

<li>sweatshop - fixtures</li>

<li>is-list, is-nested_set, is-tree, is-state_machine</li>

<li>is-searchable</li>

<li>is-versioned</li>

<li>ar-finders</li>
</ul>

</div>

<div class="slide">
<h1 id='adapters'>Adapters</h1>

<p>Powerful adapter plugins mean its not just for RDBMSs:</p>

<ul>
<li>InMemory</li>

<li><strong>Yaml files</strong></li>

<li>ReSTful web services</li>

<li>CouchDB</li>

<li>Sphinx</li>

<li>High-speed key-value stores (TokyoCabinet)</li>

<li>Salesforce, LDAP, Netflix, Google Video, &#8230;</li>
</ul>

</div>

<div class="slide">
<h1 id='what_makes_up_an_adapter'>What Makes Up an Adapter?</h1>

<p>Just a few simple methods:</p>

<ul>
<li><code>initialize(name, uri_or_options)</code></li>

<li><code>create(resources)</code></li>

<li><code>read(query)</code></li>

<li><code>update(attributes, query)</code></li>

<li><code>delete(query)</code></li>
</ul>

<p><em>Only applicable to datamapper/next</em></p>

</div>

<div class="slide">
<h1 id='initialize'>Initialize</h1>

<pre><code>def initialize(name, options)
  super   # AbstractAdapter does some extra
          # initilization for you

  # Set up the dir to store the yaml files
  @path = FileUtils.mkdir_p(@options[:path])
end</code></pre>

</div>

<div class="slide">
<h1 id='create_api'>Create (API)</h1>

<p>Used by DataMapper to put records into a data-store: &#8220;INSERT&#8221; in SQL-speak. It takes an array of the resources (model instances) to be saved. Resources each have a key that can be used to quickly look them up later without searching, if the adapter supports it.</p>

<dl>
<dt>param <code>[Enumerable(Resource)] resources</code></dt>

<dd>The set of resources (model instances)</dd>

<dt>return <code>[Enumerable(Resource)]</code></dt>

<dd>The resources that got saved.</dd>
</dl>

</div>

<div class="slide">
<h1 id='create_demo'>Create (Demo)</h1>

<pre><code>Article.create(:title =&gt; &quot;Test&quot;, :text =&gt; &quot;Lorem Ipsum&quot;)

# calls Adapter#create(resources)
resources # =&gt;
  [&lt;Article @id=nil @title=&quot;Test&quot; @text=&quot;Lorem Ipsum&quot;&gt;]

returns # =&gt;
  [&lt;Article @id=1 @title=&quot;Test&quot; @text=&quot;Lorem Ipsum&quot;&gt;]</code></pre>

</div>

<div class="slide">
<h1 id='create_yaml_adapter'>Create (YAML Adapter)</h1>

<pre><code>def create(resources)
  resources.each do |resource|                    # 1
    next_serial(resource)                         # 2
    update_records(resource.model) do |records|   # 3
      records[resource.key] = resource.attributes # 4
    end
  end
end</code></pre>

<ol class='handout'>
<li>resources is a collection of DM::Resource objects</li>

<li>we need to set the key on any Serial properties</li>

<li><code>#update_records</code> is a helper in yaml adapter that reads all records from the file for a model, yields it to the block, then writes the result back to the file.</li>

<li>Add the attributes (a Hash) for this resource to the records hash.</li>
</ol>

</div>

<div class="slide">
<h1 id='read_api'>Read (API)</h1>

<p>Looks up a set of records from the data-store that match the query.</p>

<dl>
<dt>param <code>[Query] query</code></dt>

<dd>The query to be used to seach for the resources</dd>

<dt>return <code>[Enumerable(Hash), Enumerable(Resource)]</code></dt>

<dd>The easiest way it just just return an array of hashes with keys being the property field names, and the values. eg, <code>{ &quot;id&quot; =&gt; 1, &quot;title&quot; =&gt; &quot;Article&quot;}</code>. If your adapter can build the Resource objects itself, to save time or memory, it can return those instead.</dd>
</dl>

</div>

<div class="slide">
<h1 id='read_demo'>Read (Demo)</h1>

<pre><code>a = Article.all

# calls Adapter.read(query)
query # =&gt;
&lt;DataMapper::Query 
  @model=Article 
  @fields=[&lt;DataMapper::Property @model=Article @name=:id&gt;, 
           &lt;DataMapper::Property @model=Article @name=:title&gt;] 
  @conditions=[] @links=[] @order=[] @limit=nil @offset=0&gt;

returns # =&gt;
[{:title=&gt;&quot;Test&quot;, :text=&gt;&quot;Lorem Ipsum&quot;, :id=&gt;1}]</code></pre>

</div>

<div class="slide">
<h1 id='read_yaml_adapter'>Read (YAML Adapter)</h1>

<pre><code>def read(query)
  records = records_for(query.model)     # 1
  filter_records(records.values, query)  # 2
end</code></pre>

<ol class='handout'>
<li><code>#records_for</code> reads all the records from the yaml file for this model. The records in this case is a Hash of <code>{ key =&gt; attrs }</code> pairs, with <code>key</code> being the array of keys for a record, and attrs being a hash of <code>{property_name =&gt; value}</code> pairs of attributes.</li>

<li><code>#filter_records</code> is where all the magic happens. If your data source doesn&#8217;t have any native searching or sorting capabilities, just run your records as an array of attribute hashes though this, and it will destructively remove all the records that don&#8217;t match the query. It will also sort and limit, as needed.</li>
</ol>

</div>

<div class="slide">
<h1 id='update_api'>Update (API)</h1>

<p>Used by DataMapper to update the attributes on existing records in a data-store.</p>

<dl>
<dt>param <code>[Hash] attributes</code></dt>

<dd>The set of attributes to update with, In the form of <code>{DataMapper::Property =&gt; value}</code></dd>

<dt>param <code>[Query] query</code></dt>

<dd>The query that should be used to find the resource(s) to update.</dd>

<dt>return <code>[boolean, Enumerable(Hash), Enumerable(Resource)]</code></dt>

<dd>True if all records matching the query were updated, False if any failed. Also supports returning the same Hash Array and Resource Array as <code>#read</code>.</dd>
</dl>

</div>

<div class="slide">
<h1 id='update_demo'>Update (Demo)</h1>

<pre><code>a.title = &quot;New Title&quot;
a.save

# calls Adapter#update(attributes, query)
attributes # =&gt;
{ &lt;DataMapper::Property @model=Article @name=:title&gt; =&gt;
  &quot;Test Update&quot; }

query # =&gt; 
&lt;DataMapper::Query 
@model=Article 
@conditions=&lt;DataMapper::Conditions::AndOperation ... &gt;
&gt;

returns # =&gt; true</code></pre>

</div>

<div class="slide">
<h1 id='update_yaml_adapter'>Update (YAML Adapter)</h1>

<pre><code>  def update(attributes, query)
    update_records(query.model) do |records|
      updated = filter_records(records.values, query)
      updated.each { |r| r.update(attributes) }      # 1
    end
    true
  end</code></pre>

<ol class='handout'>
<li>Update the the records that match the query with the new attributes.</li>
</ol>

</div>

<div class="slide">
<h1 id='delete_api'>Delete (API)</h1>

<p>Destroys all the records matching the given query.</p>

<dl>
<dt>param <code>[Query] query</code></dt>

<dd>The query used to locate the resources to be deleted.</dd>

<dt>return <code>[boolean, Enumerable(Hash), Enumerable(Resource)]</code></dt>

<dd>True if all records matching the query were deleted, False if any failed. Also supports the same Hash Array and Resource Array as <code>#read</code>.</dd>
</dl>

</div>

<div class="slide">
<h1 id='delete_demo'>Delete (Demo)</h1>

<pre><code>a.destroy
calls Adapter#delete(query)

query # =&gt; 
&lt;DataMapper::Query 
@model=Article 
@conditions=&lt;DataMapper::Conditions::AndOperation ... &gt;
&gt;

returns # =&gt; true</code></pre>

</div>

<div class="slide">
<h1 id='delete_yaml_adapter'>Delete (YAML Adapter)</h1>

<pre><code>  def delete(query)
    update_records(query.model) do |records|
      deleted = filter_records(records.values, query).to_set
      records.delete_if { |_k,r| deleted.include?(r) } # 1
    end

    true
  end</code></pre>

<ol class='handout'>
<li>Delete the records that match the query.</li>
</ol>

</div>

<div class="slide">
<h1 id='how_do_i_know_my_adapter_works'>How do I Know My Adapter Works?</h1>

<pre><code>describe &#39;DataMapper::Adapters::YamlAdapter&#39; do
  before :all do
    @model = Heffalump
    @string_property  = @model.color
    @integer_property = @model.num_spots
  end

  it_should_behave_like &#39;An Adapter&#39;
end</code></pre>

</div>

<div class="slide">
<h1 id='query'>Query</h1>

<ul>
<li>
<p>Query</p>

<ul>
<li>Fields</li>

<li>Conditions</li>

<li>Order</li>

<li>Limit &amp; Offset</li>
</ul>
</li>
</ul>

</div>

<div class="slide">
<h1 id='query__fields'>Query - Fields</h1>

<pre><code>@fields=[
  &lt;DataMapper::Property @model=Heffalump @name=:id&gt;, 
  &lt;DataMapper::Property @model=Heffalump @name=:color&gt;, 
  &lt;DataMapper::Property @model=Heffalump @name=:num_spots&gt;, 
  &lt;DataMapper::Property @model=Heffalump @name=:striped&gt;
]</code></pre>

</div>

<div class="slide">
<h1 id='query__conditions'>Query - Conditions</h1>

<pre><code>@conditions=
  &lt;DataMapper::Conditions::AndOperation
    @operands=[
      &lt;DataMapper::Conditions::EqualToComparison
        @property=&lt;DataMapper::Property 
                   @model=Heffalump 
                   @name=:id&gt;, 
        @value=4
      &gt;
    ]
  &gt;</code></pre>

</div>

<div class="slide">
<h1 id='query__order'>Query - Order</h1>

<pre><code>@order=[
  &lt;DataMapper::Query::Direction:0xb792e804 
    @direction=:asc, 
    @property=&lt;DataMapper::Property 
                @model=Heffalump 
                @name=:id&gt;
  &gt;
]</code></pre>

</div>

<div class="slide">
<h1 id='query__limit__offset'>Query - Limit &amp; Offset</h1>

<pre><code>@limit=20 
@offset=40</code></pre>

</div>

<div class="slide">
<h1 id='the_end'>The End</h1>

<p>~ fin ~</p></div>


</div>


</body>
</html>
